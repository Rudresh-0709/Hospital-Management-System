<script>
        // âœ… Get current user details
        const currentUser = JSON.parse(document.getElementById("currentUser").getAttribute("data-user"));
        
        let activeReceiver = null; // Stores the selected chat user
        let socket = io('/chat', { autoConnect: false ,
            query: { userId: currentUser._id }
        }); // âœ… Only connect when needed
    
        document.addEventListener("DOMContentLoaded", () => {
            console.log("ğŸš€ Chat page loaded");
    
            // âœ… Connect to socket only after the page is loaded
            if (!socket.connected) {
                socket.connect();
            }
        });
    
        // âœ… Handle user profile click to start chat
        document.querySelectorAll(".user-profile").forEach(profile => {
            profile.addEventListener("click", (event) => {
                event.preventDefault();
                
                const receiverId = event.currentTarget.getAttribute("data-user-id");
                console.log("ğŸ”¹ Clicked User Profile:", receiverId);
    
                if (!receiverId) {
                    console.error("âš ï¸ No receiverId found!");
                    return;
                }
    
                activeReceiver = { _id: receiverId };
                document.getElementById("chat-receiver-name").innerText = event.currentTarget.innerText.trim();
    
                startChatWithUser(receiverId);
            });
        });
    
        function startChatWithUser(receiverId) {
            if (!receiverId) {
                console.error("âŒ No receiverId provided!");
                return;
            }
    
            console.log("ğŸ”— Connecting to chat room:", { 
                userId: currentUser._id, 
                receiverId 
            });
    
            if (!socket.connected) {
                socket.connect();
            }
    
            // âœ… Join the chat room
            socket.emit("joinRoom", { userId: currentUser._id, receiverId });
    
            // âœ… Fetch previous messages
            fetchMessages(receiverId);
        }
    
        function fetchMessages(receiverId) {
            console.log("ğŸ“© Fetching messages for:", receiverId);
    
            fetch(`/chat/conversation?senderId=${currentUser._id}&receiverId=${receiverId}`)
                .then(response => response.json())
                .then(messages => {
                    const messageContainer = document.getElementById("message-container");
                    messageContainer.innerHTML = ""; // âœ… Clear old messages
    
                    if (Array.isArray(messages)) {
                        messages.forEach(renderMessage);
                    } else {
                        console.error("Unexpected response format:", messages);
                    }
                })
                .catch(err => console.error("âŒ Error fetching messages:", err));
        }
    
        function renderMessage(message) {
            console.log("ğŸ“© Rendering message:", message);
    
            const messageContainer = document.getElementById("message-container");
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message");
    
            const senderId = (message.senderId || message.sender._id || message.sender).toString();
            const isCurrentUser = senderId === currentUser._id.toString();
    
            const messageDate = new Date(message.timestamp);
            const formattedDate = messageDate.toLocaleTimeString();
    
            msgDiv.classList.add(isCurrentUser ? "sent" : "received");
            msgDiv.innerHTML = `
                <div class="message-content ${isCurrentUser ? "sent-message" : "received-message"}">
                    ${message.message}
                    <small>${formattedDate}</small>
                </div>
            `;
    
            messageContainer.appendChild(msgDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight; // âœ… Auto-scroll
        }
    
        // âœ… Listen for incoming messages and update the UI in real-time
        socket.on("message", (message) => {
            console.log("ğŸ“© New message received:", message);
    
            if (!activeReceiver || activeReceiver._id !== message.senderId) {
                console.log("ğŸš¨ Message is for another chat, ignoring...");
                return;
            }
    
            renderMessage(message);
        });
    
        // âœ… Prevent form from refreshing the page on submit
        document.getElementById("message-form").addEventListener("submit", function (event) {
            event.preventDefault();

            const messageInput = document.getElementById("message-input");
            const messageText = messageInput.value.trim();

            if (!messageText || !activeReceiver || !socket.connected) {
                console.warn("âš ï¸ Cannot send message. Missing data.");
                return;
            }

            const messageData = {
                senderId: currentUser._id,  // âœ… Ensure correct ID
                receiverId: activeReceiver._id, // âœ… Ensure correct ID
                message: messageText
            };

            console.log("ğŸ“¤ Sending message:", messageData);

            // âœ… Emit message
            socket.emit("chatMessage", messageData);

            // âœ… Add message to UI instantly
            renderMessage({ ...messageData, timestamp: new Date() });

            // âœ… Clear input field
            messageInput.value = "";
        });

        // âœ… Handle online/offline status updates

// âœ… Handle user going offline
// âœ… Receiving Messages (Works Fine)
// âœ… Listen for incoming messages in real-time
socket.on("chatMessage", (message) => {
    console.log("ğŸ“© New message received:", message);

    // âœ… Only update the UI if it's for the currently active chat
    if (activeReceiver && activeReceiver._id === message.senderId) {
        renderMessage(message);
    }
});


// âš ï¸ Online/Offline Status (Had Issues Before)
socket.on('userOnline', (data) => {
    console.log(`âœ… User Online Event Received:`, data);

    const userElement = document.getElementById("patient-" + data.userId);
    if (userElement) {
        const avatarContainer = userElement.querySelector(".avatar-container");
        if (avatarContainer) {
            let indicator = avatarContainer.querySelector(".online-indicator");
            if (!indicator) {
                indicator = document.createElement("span");
                indicator.classList.add("online-indicator");
                avatarContainer.appendChild(indicator);
            }
            indicator.style.backgroundColor = "green"; // âœ… Online
        }
    }
});

socket.on('userOffline', (data) => {
    console.log(`âŒ User Offline Event Received:`, data);

    const userElement = document.getElementById("patient-" + data.userId);
    if (userElement) {
        const avatarContainer = userElement.querySelector(".avatar-container");
        if (avatarContainer) {
            const indicator = avatarContainer.querySelector(".online-indicator");
            if (indicator) {
                indicator.style.backgroundColor = "red"; // âŒ Offline
            }
        }
    }
});

    </script>


    chatNamespace.on('connection', async (socket) => {
    const { userId } = socket.handshake.query;  // âœ… MongoDB _id

    if (!userId) {
        console.warn("âš ï¸ No userId provided for socket connection.");
        return;
    }

    socket.join(userId);  // âœ… Join the room with MongoDB _id
    console.log(`ğŸ“¡ User ${userId} connected (Socket ID: ${socket.id})`);

    try {
        // âœ… Update user online status in DB
        await User.findByIdAndUpdate(userId, { is_online: true });

        // âœ… Notify all users (this was the issue: notifying everyone, not just allowedUsers)
        chatNamespace.emit('userOnline', { userId });

    } catch (err) {
        console.error("âŒ Error updating user online status:", err);
    }

    // ğŸ“¨ Handle sending messages
    // socket.on('chatMessage', async ({ senderId, receiverId, message }) => {
    //     console.log(`ğŸ“¤ Message from ${senderId} to ${receiverId}:`, message);
    
    //     if (!senderId || !receiverId || !message) {
    //         console.error("âš ï¸ Missing sender, receiver, or message!");
    //         return;
    //     }
    
    //     try {
    //         const newMessage = new ChatMessage({
    //             sender: senderId,   // âœ… Changed senderId â†’ sender (matches Mongoose model)
    //             receiver: receiverId, // âœ… Changed receiverId â†’ receiver (matches Mongoose model)
    //             message: message,
    //             timestamp: new Date()
    //         });
    
    //         await newMessage.save();
    
    //         chatNamespace.to(receiverId).emit('chatMessage', { senderId, message });
    //     } catch (err) {
    //         console.error("âŒ Error saving message:", err);
    //     }
    // });
    socket.on('chatMessage', async ({ senderId, receiverId, message }) => {
        console.log(`ğŸ“¤ Message from ${senderId} to ${receiverId}:`, message);
    
        if (!senderId || !receiverId || !message) {
            console.error("âš ï¸ Missing sender, receiver, or message!");
            return;
        }
    
        try {
            const newMessage = new ChatMessage({
                sender: senderId,   
                receiver: receiverId, 
                message: message,
                timestamp: new Date()
            });
    
            await newMessage.save();
    
            // âœ… Emit to the sender and receiver
            chatNamespace.to(senderId).emit("chatMessage", { senderId, receiverId, message });
            chatNamespace.to(receiverId).emit("chatMessage", { senderId, receiverId, message });
    
            console.log(`âœ… Message sent to ${receiverId} in real-time.`);
        } catch (err) {
            console.error("âŒ Error saving message:", err);
        }
    });
    

    // ğŸ”Œ Handle user disconnection
    socket.on('disconnect', async () => {
        console.log(`ğŸ”Œ User ${userId} disconnected.`);

        try {
            // âœ… Update user offline status in DB
            await User.findByIdAndUpdate(userId, { is_online: false });

            // âœ… Notify all users (same issue: notifying everyone)
            chatNamespace.emit('userOffline', { userId });

        } catch (err) {
            console.error("âŒ Error updating user offline status:", err);
        }

        socket.leave(userId);
    });
});